<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Password & Username Generator</title>
  <!-- BACKUP: Original password-only version saved. To revert, remove username generator section and restore original title -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%230b66c3'/><circle cx='50' cy='50' r='40' fill='%23f6f8fa'/><text x='50' y='65' font-size='50' font-weight='bold' text-anchor='middle' fill='%230b66c3'>üîê</text></svg>" type="image/svg+xml">
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: #f6f8fa;
      color: #222;
      padding: 28px;
      display: flex;
      justify-content: center;
    }
    .card {
      width: 760px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      padding: 20px;
    }
    @media (max-width: 768px) {
      .card {
        width: 100%;
        max-width: 100%;
        padding: 16px;
      }
    }
    h1 { margin: 0 0 12px 0; font-size: 20px; }
    .row { display:flex; gap:12px; align-items:center; margin:8px 0; flex-wrap:wrap; }
    @media (max-width: 768px) {
      .row {
        flex-direction: column;
        align-items: flex-start;
      }
    }
    .controls { background:#eef6ec; padding:14px; border-radius:8px; margin-top:12px; }
    label { display:flex; gap:8px; align-items:center; font-size:14px; }
    input[type="range"] { width:100%; }
    input[type="text"] {
      width:100%;
      padding:12px 14px;
      font-size:18px;
      border-radius:8px;
      border:1px solid #d6dbe0;
      box-sizing: border-box;
      word-break: break-all;
      overflow-wrap: break-word;
      white-space: normal;
      resize: none;
      min-height: auto;
      height: auto;
      line-height: 1.5;
    }
    @media (max-width: 768px) {
      input[type="text"] {
        font-size: 13px;
        padding: 10px 12px;
        min-height: auto;
      }
    }
    .btn {
      padding:10px 14px;
      border-radius:8px;
      border: none;
      cursor:pointer;
      font-weight:600;
    }
    @media (max-width: 768px) {
      .btn {
        padding: 8px 10px;
        font-size: 13px;
      }
      #langEnBtn, #langEsBtn {
        padding: 6px 8px;
      }
    }
    .btn-refresh { background:#f0f6fb; color:#0b66c3; }
    .btn-copy { background:#d92d6a; color:white; }
    .small { font-size:13px; color:#444; }
    .checkboxes { display:flex; gap:18px; flex-wrap:wrap; }
    @media (max-width: 768px) {
      .checkboxes {
        flex-direction: column;
        gap: 16px;
      }
      [style*="width:280px"] {
        width: 100% !important;
      }
    }
    .footer { margin-top:16px; }
    .strength-container {
      margin-top:8px;
      height:10px;
      width:100%;
      background:#ddd;
      border-radius:5px;
      overflow:hidden;
    }
    .strength-bar {
      height:10px;
      width:0%;
      background:#ccc;
      transition: width 0.3s ease, background 0.3s ease;
    }
    .strength-label {
      font-size:13px;
      font-weight:600;
      margin-top:6px;
    }
    .hint { font-size:12px; color:#666; }
    .history-section {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #e0e0e0;
    }
    .history-title {
      font-size: 13px;
      font-weight: 600;
      color: #444;
      margin-bottom: 10px;
    }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: #f5f5f5;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
      word-break: break-all;
    }
    .history-copy-btn {
      padding: 6px 10px;
      background: #0b66c3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
      margin-left: 8px;
      flex-shrink: 0;
    }
    .history-copy-btn:hover {
      background: #0952a0;
    }
    .tab-btn {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .tab-btn:hover {
      opacity: 0.8;
    }
    .tab-active {
      font-weight: 700;
    }
    .tab-content {
      animation: fadeIn 0.2s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0.8; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="card" role="main">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h1 style="margin:0;">Password generator</h1>
        <div style="display:flex; gap:8px; flex-shrink:0;">
          <button id="langEnBtn" class="btn" style="background:#e8f0ff; color:#0b66c3; padding:8px 12px; border:2px solid #0b66c3; line-height:1; display:flex; align-items:center; justify-content:center;" title="English">
            <img src="https://emojis.wiki/emoji-pics/apple/united-states-apple.png" alt="US" style="width:30px; height:30px;">
          </button>
          <button id="langEsBtn" class="btn" style="background:#f0f0f0; color:#666; padding:8px 12px; border:2px solid #ddd; line-height:1; display:flex; align-items:center; justify-content:center;" title="Espa√±ol">
            <img src="https://hotemoji.com/images/emoji/c/eppyfhslxy8c.png" alt="SV" style="width:30px; height:30px;">
          </button>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div style="display:flex; gap:8px; margin-bottom:16px; border-bottom:2px solid #f0f0f0; padding-bottom:0;">
        <button id="passwordTab" class="tab-btn tab-active" style="padding:12px 16px; border:none; background:none; cursor:pointer; border-bottom:3px solid #0b66c3; color:#0b66c3; font-weight:600; font-size:16px;" data-i18n="passwordTab">Password</button>
        <button id="usernameTab" class="tab-btn" style="padding:12px 16px; border:none; background:none; cursor:pointer; border-bottom:3px solid transparent; color:#666; font-weight:600; font-size:16px;" data-i18n="usernameTab">Username</button>
      </div>

      <!-- Password Generator Tab -->
      <div id="passwordTabContent" class="tab-content">
    <div style="display:grid; grid-template-columns: 1fr 200px; gap:12px; align-items:flex-start; min-width: 0;">
      <textarea id="passwordField" readonly aria-label="Generated password" style="min-width: 0; width: 100%; padding: 12px 14px; font-size: 18px; border-radius: 8px; border: 1px solid #d6dbe0; box-sizing: border-box; word-break: break-all; overflow-wrap: break-word; white-space: normal; resize: none; line-height: 1.5; font-family: monospace;"></textarea>
      <div style="display:flex; gap:8px; flex-shrink: 0;">
        <button id="refreshBtn" class="btn btn-refresh" title="Generate new password" data-i18n="refresh">‚ü≤ Refresh</button>
        <button id="copyBtn" class="btn btn-copy" title="Copy password to clipboard" data-i18n="copy">Copy password</button>
      </div>
    </div>

    <style>
      #passwordField {
        resize: none;
        overflow: hidden;
        min-height: 0;
        padding: 12px 14px;
      }
      @media (max-width: 768px) {
        #passwordField {
          font-size: 13px;
          padding: 10px 12px;
          min-height: 0;
        }
        [style*="grid-template-columns: 1fr 200px"] {
          grid-template-columns: 1fr !important;
          min-width: 0 !important;
        }
        [style*="grid-template-columns: 1fr 200px"] > div {
          display: flex !important;
          flex-direction: column !important;
          gap: 8px !important;
          width: 100%;
          flex-shrink: 0;
        }
        [style*="grid-template-columns: 1fr 200px"] > div > button {
          width: 100%;
        }
      }
    </style>

    <div class="controls">
      <div class="row">
        <div style="flex:1;">
          <div class="small" style="display:flex; gap:12px; align-items:center;">
            <label for="lengthInput" data-i18n="passwordLength">Password length:</label>
            <input id="lengthInput" type="number" min="5" max="100" value="20" style="width:60px; padding:6px 8px; border:1px solid #d6dbe0; border-radius:4px; font-size:14px;" />
          </div>
          <input id="lengthRange" type="range" min="5" max="100" value="20" />
        </div>

        <div style="width:280px;">
          <div class="small" data-i18n="charactersUsed">Characters used</div>
          <div class="checkboxes" style="margin-top:8px;">
            <label><input id="upper" type="checkbox" checked /> <span data-i18n="uppercase">Uppercase</span></label>
            <label><input id="lower" type="checkbox" checked /> <span data-i18n="lowercase">Lowercase</span></label>
            <label><input id="numbers" type="checkbox" checked /> <span data-i18n="numbers">Numbers</span></label>
            <label><input id="symSimple" type="checkbox" checked /> <span data-i18n="symbolsSimple">Symbols</span> <span class="hint" data-i18n="simple">(Simple)</span></label>
            <label><input id="symComplex" type="checkbox" /> <span data-i18n="symbolsComplex">Symbols</span> <span class="hint" data-i18n="complex">(Complex)</span></label>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:12px; flex-direction:column; align-items:flex-start;">
        <label><input id="avoidRepeats" type="checkbox" checked /> <span data-i18n="avoidRepeats">Avoid immediate repeated characters</span></label>
        <label><input id="avoidSequential" type="checkbox" /> <span data-i18n="avoidSequential">Avoid sequential runs (e.g. abc, 123)</span></label>
        <span class="hint" data-i18n="minMax">Min length 5 ‚Äî Max 100</span>
      </div>
    </div>
      </div> <!-- End password tab content -->

      <!-- Username Generator Tab -->
      <div id="usernameTabContent" class="tab-content" style="display:none;">
    <div style="display:grid; grid-template-columns: 1fr 200px; gap:12px; align-items:flex-start; min-width: 0;">
      <textarea id="usernameField" readonly aria-label="Generated username" style="min-width: 0; width: 100%; padding: 12px 14px; font-size: 18px; border-radius: 8px; border: 1px solid #d6dbe0; box-sizing: border-box; word-break: break-all; overflow-wrap: break-word; white-space: normal; resize: none; line-height: 1.5; font-family: monospace; height:60px;"></textarea>
      <div style="display:flex; gap:8px; flex-shrink: 0;">
        <button id="refreshUsernameBtn" class="btn btn-refresh" title="Generate new username" data-i18n="refresh">‚ü≤ Refresh</button>
        <button id="copyUsernameBtn" class="btn btn-copy" title="Copy username to clipboard" data-i18n="copyUsername">Copy</button>
      </div>
    </div>

    <div class="controls">
      <div class="row">
        <div style="flex:1;">
          <div class="small" style="display:flex; gap:12px; align-items:center; display:none;">
            <label for="usernameLengthInput" data-i18n="usernameLength">Username length:</label>
            <input id="usernameLengthInput" type="number" min="3" max="50" value="50" style="width:60px; padding:6px 8px; border:1px solid #d6dbe0; border-radius:4px; font-size:14px;" />
          </div>
          <input id="usernameLengthRange" type="range" min="3" max="50" value="50" style="display:none;" />
        </div>
      </div>

      <!-- Gender selection - only visible in Spanish -->
      <div id="genderSelection" class="row" style="display:none;">
        <div style="flex:1;">
          <div class="small" style="font-weight:bold; font-size:14px; margin-bottom:8px;" data-i18n="genderSelection">G√©nero:</div>
          <div class="checkboxes" style="flex-direction:row; gap:16px;">
            <label><input id="genderMasculine" type="radio" name="gender" value="masculine" checked /> <span data-i18n="masculine">Masculino</span></label>
            <label><input id="genderFeminine" type="radio" name="gender" value="feminine" /> <span data-i18n="feminine">Femenino</span></label>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:20px;">
        <div style="flex:1;">
          <div class="small" style="font-weight:bold; font-size:14px; margin-bottom:8px;" data-i18n="usernameStyle">Username style:</div>
          <div class="checkboxes" style="flex-direction:column; gap:8px;">
            <label><input id="usernameStyleSimple" type="radio" name="username-style" value="simple" checked /> <span data-i18n="styleSimple">Simple (adjective + noun)</span></label>
            <label><input id="usernameStyleNumber" type="radio" name="username-style" value="number" /> <span data-i18n="styleNumber">With numbers</span></label>
            <label><input id="usernameStyleUnderscore" type="radio" name="username-style" value="underscore" /> <span data-i18n="styleUnderscore">With underscores</span></label>
            <label><input id="usernameStyleProfessional" type="radio" name="username-style" value="professional" /> <span data-i18n="styleProfessional">Professional (lowercase, numbers)</span></label>
          </div>
        </div>
      </div>
    </div>

      <div class="history-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div class="history-title" data-i18n="usernameHistory">Username History (Last 5)</div>
          <button id="clearUsernameHistoryBtn" class="btn btn-refresh" style="padding:6px 10px; font-size:12px;" data-i18n="clear">Clear</button>
        </div>
        <div id="usernameHistoryList" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:8px;"></div>
      </div>
      </div> <!-- End username tab content -->

    <div class="footer">
      <div id="passwordFooter" class="strength-container">
        <div id="strengthBar" class="strength-bar"></div>
      </div>
      <div id="strengthLabelContainer">
        <div id="strengthLabel" class="strength-label">Strength: ‚Äî</div>
      </div>

      <div id="passwordHistorySection" class="history-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div class="history-title" data-i18n="history">Password History (Last 5)</div>
          <button id="clearHistoryBtn" class="btn btn-refresh" style="padding:6px 10px; font-size:12px;" data-i18n="clear">Clear</button>
        </div>
        <div id="historyList" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:8px;"></div>
      </div>
    </div>
  </div>

  <script>
    // Character sets
    const UPPER = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const LOWER = "abcdefghijklmnopqrstuvwxyz";
    const NUMS  = "0123456789";
    const SIMPLE_SYM = "!@#$%&*?";
    const COMPLEX_SYM = "~^()_-+=[]{}|;:'\",.<>/\\`‚Ç¨¬£¬•‚Ä¢";

    // Username word lists by language
    const wordsByLanguage = {
      en: {
        adjectives: [
          "happy", "sunny", "bright", "swift", "clever", "bold", "calm", "eager",
          "fresh", "gentle", "grand", "quick", "quiet", "rare", "sharp", "smart",
          "smooth", "solid", "sweet", "tiny", "vivid", "warm", "wise", "blue",
          "green", "brave", "dark", "fair", "fine", "keen", "neat", "real",
          "dangerous", "frightful", "delicious", "mysterious", "inspiring", "colorless",
          "worthless", "pointless", "hospitable", "affordable", "incredible", "profitable",
          "predictive", "supportive", "responsive", "aggressive", "charitable", "dependable",
          "respectful", "trustworthy"
        ],
        nouns: [
          "bear", "bird", "cat", "deer", "dog", "eagle", "fish", "fox",
          "goat", "hawk", "horse", "lion", "mouse", "otter", "panda", "penguin",
          "rabbit", "raven", "seal", "shark", "snake", "spider", "swan", "tiger",
          "wolf", "zebra", "ant", "bee", "bug", "owl", "ape", "elk", "volcanoes",
          "backpacks", "chemistry", "horsepower", "journalist", "basketball", "apartment",
          "blueprints", "chocolate", "motorcycle", "bookstores", "earthquake", "playground",
          "television", "restaurant", "spaceships", "frameworks", "tournament", "cellphones", "greenhouse"
        ]
      },
      es: {
        adjectivesMasculine: [
          "feliz", "soleado", "brillante", "rapido", "inteligente", "audaz", "tranquilo", "ansioso",
          "fresco", "amable", "grandioso", "silencioso", "raro", "agudo", "suave", "solido",
          "dulce", "minusculo", "vivido", "calido", "sabio", "azul", "verde", "valiente",
          "oscuro", "justo", "fino", "pulcro", "verdadero", "peligroso", "espantoso",
          "delicioso", "misterioso", "inspirador", "incoloro", "inutil", "hospitalario",
          "asequible", "increible", "rentable"
        ],
        adjectivesFeminine: [
          "feliz", "soleada", "brillante", "rapida", "inteligente", "audaz", "tranquila", "ansiosa",
          "fresca", "amable", "grandiosa", "silenciosa", "rara", "aguda", "suave", "solida",
          "dulce", "minuscula", "vivida", "calida", "sabia", "azul", "verde", "valiente",
          "oscura", "justa", "fina", "pulcra", "verdadera", "peligrosa", "espantosa",
          "deliciosa", "misteriosa", "inspiradora", "incolora", "inutil", "hospitalaria",
          "asequible", "increible", "rentable"
        ],
        nounsMasculine: [
          "oso", "pajaro", "gato", "ciervo", "perro", "aguila", "pez", "zorro",
          "caballo", "leon", "raton", "panda", "pinguino", "conejo", "cuervo", "tiburon",
          "tigre", "lobo", "insecto", "buho", "mono", "alce", "apartamento", "chocolate",
          "baloncesto", "terremoto", "patio", "recreo", "torneo", "invernadero"
        ],
        nounsFeminine: [
          "osa", "pajara", "gata", "cierva", "perra", "aguila", "pez", "zorra",
          "cabra", "halcon", "yegua", "leona", "ratona", "nutria", "panda", "pinguina",
          "coneja", "cuerva", "foca", "serpiente", "arana", "cisne", "tigresa",
          "loba", "cebra", "hormiga", "abeja", "insecta", "buha", "mona", "alce",
          "quimica", "mochila", "potencia", "periodista", "motocicleta", "libreria",
          "television", "nave", "marca", "telefona"
        ]
      }
    };

    // Translations
    const translations = {
      en: {
        title: "Password generator",
        passwordLength: "Password length:",
        charactersUsed: "Characters used",
        uppercase: "Uppercase",
        lowercase: "Lowercase",
        numbers: "Numbers",
        symbolsSimple: "Symbols",
        symbolsComplex: "Symbols",
        simple: "(Simple)",
        complex: "(Complex)",
        avoidRepeats: "Avoid immediate repeated characters",
        avoidSequential: "Avoid sequential runs (e.g. abc, 123)",
        minMax: "Min length 5 ‚Äî Max 100",
        strength: "Strength:",
        refresh: "‚ü≤ Refresh",
        copy: "Copy password",
        copied: "Copied!",
        history: "Password History (Last 5)",
        clear: "Clear",
        weak: "Weak",
        fair: "Fair",
        medium: "Medium",
        strong: "Strong",
        veryStrong: "Very strong",
        usernameTab: "Username",
        passwordTab: "Password",
        usernameLength: "Username length:",
        usernameStyle: "Username style:",
        styleSimple: "Simple (adjective + noun)",
        styleNumber: "With numbers",
        styleUnderscore: "With underscores",
        styleProfessional: "Professional",
        generateUsername: "Generate Username",
        copyUsername: "Copy username",
        usernameHistory: "Username History (Last 5)",
        genderSelection: "Gender:",
        masculine: "Masculine",
        feminine: "Feminine"
      },
      es: {
        title: "Generador de contrase√±a",
        passwordLength: "Longitud de contrase√±a:",
        charactersUsed: "Caracteres utilizados",
        uppercase: "May√∫sculas",
        lowercase: "Min√∫sculas",
        numbers: "N√∫meros",
        symbolsSimple: "S√≠mbolos",
        symbolsComplex: "S√≠mbolos",
        simple: "(Simple)",
        complex: "(Complejo)",
        avoidRepeats: "Evitar caracteres repetidos inmediatos",
        avoidSequential: "Evitar secuencias consecutivas (p. ej. abc, 123)",
        minMax: "Longitud m√≠n. 5 ‚Äî M√°x. 100",
        strength: "Fortaleza:",
        refresh: "‚ü≤ Actualizar",
        copy: "Copiar contrase√±a",
        copied: "¬°Copiado!",
        history: "Historial de contrase√±a (√öltimas 5)",
        clear: "Limpiar",
        weak: "D√©bil",
        fair: "Aceptable",
        medium: "Media",
        strong: "Fuerte",
        veryStrong: "Muy fuerte",
        usernameTab: "Nombre de usuario",
        passwordTab: "Contrase√±a",
        usernameLength: "Longitud del nombre de usuario:",
        usernameStyle: "Estilo de nombre de usuario:",
        styleSimple: "Simple (adjetivo + sustantivo)",
        styleNumber: "Con n√∫meros",
        styleUnderscore: "Con guiones bajos",
        styleProfessional: "Profesional",
        generateUsername: "Generar nombre de usuario",
        copyUsername: "Copiar nombre de usuario",
        usernameHistory: "Historial de nombres de usuario (√öltimos 5)",
        genderSelection: "G√©nero:",
        masculine: "Masculino",
        feminine: "Femenino"
      }
    };

    let currentLanguage = 'en';

    // DOM elements
    const passwordField = document.getElementById('passwordField');
    const lengthRange = document.getElementById('lengthRange');
    const lengthInput = document.getElementById('lengthInput');
    const refreshBtn = document.getElementById('refreshBtn');
    const copyBtn = document.getElementById('copyBtn');
    const upperEl = document.getElementById('upper');
    const lowerEl = document.getElementById('lower');
    const numbersEl = document.getElementById('numbers');
    const symSimpleEl = document.getElementById('symSimple');
    const symComplexEl = document.getElementById('symComplex');
    const avoidRepeatsEl = document.getElementById('avoidRepeats');
    const avoidSequentialEl = document.getElementById('avoidSequential');
    const strengthLabel = document.getElementById('strengthLabel');
    const strengthBar = document.getElementById('strengthBar');
    const historyList = document.getElementById('historyList');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const langEnBtn = document.getElementById('langEnBtn');
    const langEsBtn = document.getElementById('langEsBtn');
    let passwordHistory = [];

    function buildCharset() {
      let charset = "";
      const activeCategories = [];
      if (upperEl.checked) { charset += UPPER; activeCategories.push(UPPER); }
      if (lowerEl.checked) { charset += LOWER; activeCategories.push(LOWER); }
      if (numbersEl.checked) { charset += NUMS; activeCategories.push(NUMS); }
      if (symSimpleEl.checked) { charset += SIMPLE_SYM; activeCategories.push(SIMPLE_SYM); }
      if (symComplexEl.checked) { charset += COMPLEX_SYM; activeCategories.push(COMPLEX_SYM); }
      return { charset, activeCategories };
    }

    function randInt(max) {
      if (window.crypto && window.crypto.getRandomValues) {
        const array = new Uint32Array(1);
        window.crypto.getRandomValues(array);
        return array[0] % max;
      } else return Math.floor(Math.random() * max);
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = randInt(i + 1);
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // Detect sequential runs like "abc", "123", or reverse "cba", "321"
    function hasSequentialRun(pw) {
      const seqs = [];
      for (let i = 0; i < pw.length - 2; i++) {
        const a = pw.charCodeAt(i);
        const b = pw.charCodeAt(i + 1);
        const c = pw.charCodeAt(i + 2);
        if ((b === a + 1 && c === b + 1) || (b === a - 1 && c === b - 1)) return true;
      }
      return false;
    }

    function generatePassword(length) {
      const { charset, activeCategories } = buildCharset();
      if (!charset) return { pw: "", reason: "Select at least one character set." };
      if (length < 1) return { pw: "", reason: "Invalid length." };

      const mandatory = [];
      for (const cat of activeCategories) mandatory.push(cat.charAt(randInt(cat.length)));

      const remainingCount = length - mandatory.length;
      if (remainingCount < 0)
        return { pw: "", reason: `Length too short for chosen categories.` };

      const result = [...mandatory];
      const avoidRepeats = avoidRepeatsEl.checked;
      const avoidSequential = avoidSequentialEl.checked;

      let attempt = 0;
      while (result.length < length) {
        let ch = charset.charAt(randInt(charset.length));
        if (avoidRepeats && result.length > 0 && ch === result[result.length - 1]) continue;
        result.push(ch);
        attempt++;
        if (attempt > 500) break;
      }

      shuffle(result);

      // Remove any repeated or sequential runs post-generation if enabled
      if (avoidRepeats) {
        for (let i = 1; i < result.length; i++) {
          if (result[i] === result[i - 1]) {
            result[i] = charset.charAt(randInt(charset.length));
          }
        }
      }

      let pw = result.join("");

      // If avoiding sequential runs, regenerate up to a few times
      if (avoidSequential) {
        let tries = 0;
        while (hasSequentialRun(pw) && tries < 10) {
          pw = generatePassword(length).pw;
          tries++;
        }
      }

      return { pw, reason: null };
    }

    function estimateStrength(pw) {
      if (!pw) return { label: "‚Äî", score: 0 };
      
      const len = pw.length;
      let charsetSize = 0;
      let hasUpper = /[A-Z]/.test(pw);
      let hasLower = /[a-z]/.test(pw);
      let hasNumbers = /[0-9]/.test(pw);
      let hasSymbols = /[^A-Za-z0-9]/.test(pw);
      
      // Calculate charset size based on character types present
      if (hasUpper) charsetSize += 26;
      if (hasLower) charsetSize += 26;
      if (hasNumbers) charsetSize += 10;
      if (hasSymbols) charsetSize += 32; // Approximate
      
      // Calculate entropy in bits: log2(charsetSize^length)
      // Simplified: entropy = len * log2(charsetSize)
      const entropy = len * Math.log2(charsetSize);
      
      // NIST & OWASP standards for entropy:
      // Very strong: 80+ bits with all 4 character types
      // Strong: 60-79 bits with mixed types
      // Medium: 40-59 bits with at least 2 types
      // Weak: <40 bits or insufficient character diversity
      
      let strength = "Weak";
      let pct = 20;
      let typeCount = (hasUpper ? 1 : 0) + (hasLower ? 1 : 0) + (hasNumbers ? 1 : 0) + (hasSymbols ? 1 : 0);
      
      if (entropy >= 80 && typeCount === 4) {
        strength = "Very strong";
        pct = 100;
      } else if (entropy >= 60 && typeCount >= 3) {
        strength = "Strong";
        pct = 80;
      } else if (entropy >= 40 && typeCount >= 2) {
        strength = "Medium";
        pct = 60;
      } else if (entropy >= 30 && typeCount >= 2) {
        strength = "Fair";
        pct = 40;
      } else {
        strength = "Weak";
        pct = 20;
      }
      
      return { label: strength, score: pct };
    }

    function updateHistory(pw) {
      if (!pw) return;
      // Remove if it already exists (to avoid duplicates and move it to top)
      passwordHistory = passwordHistory.filter(p => p !== pw);
      // Add to front
      passwordHistory.unshift(pw);
      // Keep only last 5
      passwordHistory = passwordHistory.slice(0, 5);
      renderHistory();
    }

    function renderHistory() {
      historyList.innerHTML = '';
      passwordHistory.forEach((pw, index) => {
        const item = document.createElement('div');
        item.className = 'history-item';
        const copyBtn = document.createElement('button');
        copyBtn.className = 'history-copy-btn';
        copyBtn.textContent = translations[currentLanguage].copy;
        copyBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(pw);
            copyBtn.textContent = translations[currentLanguage].copied;
            setTimeout(() => (copyBtn.textContent = translations[currentLanguage].copy), 1400);
          } catch {
            copyBtn.select();
            document.execCommand('copy');
            copyBtn.textContent = translations[currentLanguage].copied;
            setTimeout(() => (copyBtn.textContent = translations[currentLanguage].copy), 1400);
          }
        });
        item.innerHTML = `<span>${pw}</span>`;
        item.appendChild(copyBtn);
        historyList.appendChild(item);
      });
    }

    function updateLanguage(lang) {
      currentLanguage = lang;
      
      // Update button styles
      if (lang === 'en') {
        langEnBtn.style.background = '#e8f0ff';
        langEnBtn.style.color = '#0b66c3';
        langEnBtn.style.borderColor = '#0b66c3';
        langEsBtn.style.background = '#f0f0f0';
        langEsBtn.style.color = '#666';
        langEsBtn.style.borderColor = '#ddd';
      } else {
        langEsBtn.style.background = '#e8f0ff';
        langEsBtn.style.color = '#0b66c3';
        langEsBtn.style.borderColor = '#0b66c3';
        langEnBtn.style.background = '#f0f0f0';
        langEnBtn.style.color = '#666';
        langEnBtn.style.borderColor = '#ddd';
      }
      
      // Update all elements with data-i18n attribute
      const t = translations[lang];
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
          el.textContent = t[key];
        }
      });
      
      // Update title
      document.querySelector('h1').textContent = t.title;
      
      // Show/hide gender selection based on language
      const genderSelection = document.getElementById('genderSelection');
      if (genderSelection) {
        genderSelection.style.display = lang === 'es' ? 'flex' : 'none';
      }
      
      renderHistory();
      renderUsernameHistory();
      refreshPassword();
      
      // If currently on username tab, refresh username with new language
      const usernameTabContent = document.getElementById('usernameTabContent');
      if (usernameTabContent && usernameTabContent.style.display !== 'none') {
        refreshUsername();
      }
    }

    function refreshPassword() {
      const length = Math.max(5, Math.min(100, Number(lengthRange.value || 20)));
      const { pw, reason } = generatePassword(length);
      if (reason) {
        passwordField.value = reason;
        strengthLabel.textContent = translations[currentLanguage].strength + " ‚Äî";
        strengthBar.style.width = "0%";
        strengthBar.style.background = "#ccc";
      } else {
        passwordField.value = pw;
        autoResizePasswordField();
        const { label, score } = estimateStrength(pw);
        const translatedLabel = translations[currentLanguage][
          label === "Very strong" ? "veryStrong" :
          label === "Strong" ? "strong" :
          label === "Medium" ? "medium" :
          label === "Fair" ? "fair" :
          "weak"
        ];
        strengthLabel.textContent = translations[currentLanguage].strength + " " + translatedLabel;
        strengthBar.style.width = score + "%";
        strengthBar.style.background =
          label === "Very strong" ? "#2a8a44" :
          label === "Strong" ? "#4caf50" :
          label === "Medium" ? "#ffc107" :
          "#f44336";
      }
    }

    function autoResizePasswordField() {
      passwordField.style.height = '0px';
      const scrollHeight = passwordField.scrollHeight;
      passwordField.style.height = scrollHeight + 'px';
    }

    // Username generation functions
    let usernameHistory = [];

    function generateUsername(length, style) {
      length = Math.max(3, Math.min(50, length));
      let username = '';

      // Get word lists for current language
      const currentWords = wordsByLanguage[currentLanguage];
      let adjectives, nouns;
      
      if (currentLanguage === 'es') {
        // For Spanish, use gender-specific adjectives and nouns
        const selectedGender = document.querySelector('input[name="gender"]:checked')?.value || 'masculine';
        adjectives = selectedGender === 'feminine' ? currentWords.adjectivesFeminine : currentWords.adjectivesMasculine;
        nouns = selectedGender === 'feminine' ? currentWords.nounsFeminine : currentWords.nounsMasculine;
      } else {
        // For English, use regular adjectives and nouns
        adjectives = currentWords.adjectives;
        nouns = currentWords.nouns;
      }

      switch(style) {
        case 'simple': {
          // Build username by combining words with correct language order
          const adj = adjectives[randInt(adjectives.length)];
          const noun = nouns[randInt(nouns.length)];
          
          // Spanish: noun + adjective, English: adjective + noun
          username = currentLanguage === 'es' ? noun + adj : adj + noun;
          
          // If too short, add numbers; if too long, truncate
          if (username.length < length) {
            username += Math.floor(Math.random() * 100);
          }
          break;
        }
        case 'number': {
          const adj = adjectives[randInt(adjectives.length)];
          const noun = nouns[randInt(nouns.length)];
          
          // Spanish: noun + adjective, English: adjective + noun
          let base = currentLanguage === 'es' ? noun + adj : adj + noun;
          const num = randInt(100);
          username = base + num;
          
          // Adjust to target length
          if (username.length < length) {
            username += Math.floor(Math.random() * 1000);
          }
          break;
        }
        case 'underscore': {
          const adj = adjectives[randInt(adjectives.length)];
          const noun = nouns[randInt(nouns.length)];
          
          // Spanish: noun + adjective, English: adjective + noun
          if (currentLanguage === 'es') {
            username = noun + '_' + adj + randInt(10);
          } else {
            username = adj + '_' + noun + randInt(10);
          }
          
          // Adjust to target length
          if (username.length < length) {
            username += randInt(100);
          }
          break;
        }
        case 'professional': {
          // Professional style: clean, neutral usernames
          const neutralTerms = currentLanguage === 'en'
            ? ['alpha', 'beta', 'gamma', 'delta', 'echo', 'nova', 'prime', 'core', 'edge', 'flex']
            : ['alfa', 'beta', 'gama', 'delta', 'eco', 'nova', 'primo', 'nucleo', 'borde', 'flex'];
          
          const concepts = currentLanguage === 'en'
            ? ['wave', 'point', 'link', 'path', 'zone', 'base', 'node', 'axis', 'grid', 'flow']
            : ['onda', 'punto', 'enlace', 'ruta', 'zona', 'base', 'nodo', 'eje', 'red', 'flujo'];
          
          const term = neutralTerms[randInt(neutralTerms.length)];
          const concept = concepts[randInt(concepts.length)];
          const num = 100 + randInt(900); // 100-999
          
          // Different clean formats
          const formats = [
            term + concept,
            term + num,
            concept + num,
            term + concept + (num % 100),
            term + (num % 100),
            concept + (num % 100)
          ];
          
          username = formats[randInt(formats.length)];
          break;
        }
      }

      return username.slice(0, length);
    }

    function updateUsernameHistory(username) {
      if (!usernameHistory.includes(username)) {
        usernameHistory.unshift(username);
        if (usernameHistory.length > 5) {
          usernameHistory.pop();
        }
      }
    }

    function renderUsernameHistory() {
      const historyDiv = document.getElementById('usernameHistoryList');
      if (!historyDiv) return;
      historyDiv.innerHTML = '';
      usernameHistory.forEach(username => {
        const item = document.createElement('div');
        item.className = 'history-item';
        const copyBtn = document.createElement('button');
        copyBtn.className = 'history-copy-btn';
        copyBtn.textContent = translations[currentLanguage].copyUsername;
        copyBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(username);
            copyBtn.textContent = translations[currentLanguage].copied;
            setTimeout(() => (copyBtn.textContent = translations[currentLanguage].copyUsername), 1400);
          } catch {
            copyBtn.select();
            document.execCommand('copy');
            copyBtn.textContent = translations[currentLanguage].copied;
            setTimeout(() => (copyBtn.textContent = translations[currentLanguage].copyUsername), 1400);
          }
        });
        item.innerHTML = `<span>${username}</span>`;
        item.appendChild(copyBtn);
        historyDiv.appendChild(item);
      });
    }

    // Tab switching
    function switchTab(tabName) {
      const passwordTab = document.getElementById('passwordTab');
      const usernameTab = document.getElementById('usernameTab');
      const passwordContent = document.getElementById('passwordTabContent');
      const usernameContent = document.getElementById('usernameTabContent');

      if (tabName === 'password') {
        passwordTab.classList.add('tab-active');
        usernameTab.classList.remove('tab-active');
        passwordTab.style.borderBottomColor = '#0b66c3';
        passwordTab.style.color = '#0b66c3';
        usernameTab.style.borderBottomColor = 'transparent';
        usernameTab.style.color = '#666';
        passwordContent.style.display = 'block';
        usernameContent.style.display = 'none';
        document.getElementById('passwordFooter').style.display = 'block';
        document.getElementById('strengthLabelContainer').style.display = 'block';
        document.getElementById('passwordHistorySection').style.display = 'block';
      } else {
        usernameTab.classList.add('tab-active');
        passwordTab.classList.remove('tab-active');
        usernameTab.style.borderBottomColor = '#0b66c3';
        usernameTab.style.color = '#0b66c3';
        passwordTab.style.borderBottomColor = 'transparent';
        passwordTab.style.color = '#666';
        passwordContent.style.display = 'none';
        usernameContent.style.display = 'block';
        document.getElementById('passwordFooter').style.display = 'none';
        document.getElementById('strengthLabelContainer').style.display = 'none';
        document.getElementById('passwordHistorySection').style.display = 'none';
        refreshUsername();
      }
    }

    function refreshUsername() {
      const length = Math.max(3, Math.min(50, Number(document.getElementById('usernameLengthInput').value || 12)));
      const style = document.querySelector('input[name="username-style"]:checked').value;
      const username = generateUsername(length, style);
      document.getElementById('usernameField').value = username;
    }

    // Event listeners
    lengthRange.addEventListener('input', () => {
      lengthInput.value = lengthRange.value;
      refreshPassword();
    });
    lengthInput.addEventListener('change', () => {
      let val = Math.max(5, Math.min(100, Number(lengthInput.value || 5)));
      lengthRange.value = val;
      lengthInput.value = val;
      refreshPassword();
    });
    [lengthRange, upperEl, lowerEl, numbersEl, symSimpleEl, symComplexEl, avoidRepeatsEl, avoidSequentialEl]
      .forEach(el => {
        el.addEventListener('change', refreshPassword);
        el.addEventListener('input', refreshPassword);
      });
    refreshBtn.addEventListener('click', refreshPassword);
    clearHistoryBtn.addEventListener('click', () => {
      passwordHistory = [];
      renderHistory();
    });
    langEnBtn.addEventListener('click', () => updateLanguage('en'));
    langEsBtn.addEventListener('click', () => updateLanguage('es'));
    copyBtn.addEventListener('click', async () => {
      const txt = passwordField.value;
      if (!txt) return;
      updateHistory(txt);
      try {
        await navigator.clipboard.writeText(txt);
        copyBtn.textContent = translations[currentLanguage].copied;
        setTimeout(() => (copyBtn.textContent = translations[currentLanguage].copy), 1400);
      } catch {
        passwordField.select();
        document.execCommand('copy');
        copyBtn.textContent = translations[currentLanguage].copied;
        setTimeout(() => (copyBtn.textContent = translations[currentLanguage].copy), 1400);
      }
    });

    // Tab switching listeners
    document.getElementById('passwordTab').addEventListener('click', () => switchTab('password'));
    document.getElementById('usernameTab').addEventListener('click', () => switchTab('username'));

    // Username event listeners
    const usernameLengthInput = document.getElementById('usernameLengthInput');
    const usernameLengthRange = document.getElementById('usernameLengthRange');
    const refreshUsernameBtn = document.getElementById('refreshUsernameBtn');
    const copyUsernameBtn = document.getElementById('copyUsernameBtn');
    const clearUsernameHistoryBtn = document.getElementById('clearUsernameHistoryBtn');
    const usernameStyleRadios = document.querySelectorAll('input[name="username-style"]');
    const genderRadios = document.querySelectorAll('input[name="gender"]');

    usernameLengthRange.addEventListener('input', () => {
      usernameLengthInput.value = usernameLengthRange.value;
      refreshUsername();
    });
    usernameLengthInput.addEventListener('change', () => {
      let val = Math.max(3, Math.min(50, Number(usernameLengthInput.value || 12)));
      usernameLengthRange.value = val;
      usernameLengthInput.value = val;
      refreshUsername();
    });
    refreshUsernameBtn.addEventListener('click', refreshUsername);
    usernameStyleRadios.forEach(radio => {
      radio.addEventListener('change', refreshUsername);
    });
    genderRadios.forEach(radio => {
      radio.addEventListener('change', refreshUsername);
    });
    clearUsernameHistoryBtn.addEventListener('click', () => {
      usernameHistory = [];
      renderUsernameHistory();
    });
    copyUsernameBtn.addEventListener('click', async () => {
      const txt = document.getElementById('usernameField').value;
      if (!txt) return;
      updateUsernameHistory(txt);
      renderUsernameHistory();
      try {
        await navigator.clipboard.writeText(txt);
        copyUsernameBtn.textContent = translations[currentLanguage].copied;
        setTimeout(() => (copyUsernameBtn.textContent = translations[currentLanguage].copyUsername), 1400);
      } catch {
        document.getElementById('usernameField').select();
        document.execCommand('copy');
        copyUsernameBtn.textContent = translations[currentLanguage].copied;
        setTimeout(() => (copyUsernameBtn.textContent = translations[currentLanguage].copyUsername), 1400);
      }
    });

    updateLanguage('en');
    refreshPassword();
  </script>
</body>
</html>
